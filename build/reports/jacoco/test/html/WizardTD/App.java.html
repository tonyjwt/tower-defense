<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">scaffold</a> &gt; <a href="index.source.html" class="el_package">WizardTD</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package WizardTD;

import processing.core.PApplet;
import processing.core.PImage;
import processing.data.JSONArray;
import processing.data.JSONObject;
import processing.event.MouseEvent;

import java.awt.Graphics2D;
import java.awt.geom.AffineTransform;
import java.awt.image.BufferedImage;

import java.io.*;
import java.lang.reflect.Array;
import java.util.*;

import com.jogamp.newt.event.KeyEvent;

import WizardTD.ButtonController.ButtonAction;

/**
* App class. The bulk of the program is executed from this class.
*/
public class App extends PApplet { // extend PApplet means that App class inherits from PApplet. PApplet allows for window pop up, frame rates, etc

    // UI constants
    public static final int CELLSIZE = 32;
    public static final int SIDEBAR = 120;
    public static final int TOPBAR = 40;
    public static final int BOARD_WIDTH = 20;
    public static final int MANA_BAR_LENGTH = 340;
    public static final int BUTTON_LEFT_MARGIN = 10;
    public static final int BUTTON_TOP_MARGIN = 10;
<span class="fc" id="L34">    public static int WIDTH = CELLSIZE*BOARD_WIDTH + SIDEBAR;</span>
<span class="fc" id="L35">    public static int HEIGHT = CELLSIZE*BOARD_WIDTH + TOPBAR;</span>

    // DISPLAY CONSTANTS
<span class="fc" id="L38">    private final int WIZARD_X_OFFSET = -8; // OFFSET of -8 to centre the wizard house in its tile</span>
<span class="fc" id="L39">    private final int WIZARD_Y_OFFSET = -8; // OFFSET of -8 to centre the wizard house in its tile</span>
<span class="fc" id="L40">    public final int BOMB_X_OFFSET = -16;</span>
<span class="fc" id="L41">    public final int BOMB_Y_OFFSET = -28;</span>

    // PImage variables
<span class="fc" id="L44">    public final int NUMBER_OF_GREMLIN_DEATH_FRAMES = 5;</span>
    private PImage grassSprite;
    public PImage gremlinSprite;
    public PImage bombSprite;
<span class="fc" id="L48">    public ArrayList&lt;PImage&gt; gremlinDeathSprites = new ArrayList&lt;&gt;();</span>
    private PImage path0_1Sprite;
    private PImage path0_2Sprite;
    private PImage path1_1Sprite;
    private PImage path1_2Sprite;
    private PImage path1_3Sprite;
    private PImage path1_4Sprite;
    private PImage path2_1Sprite;
    private PImage path2_2Sprite;
    private PImage path2_3Sprite;
    private PImage path2_4Sprite;
    private PImage path3Sprite;
    private PImage shrubSprite;
    public PImage tower0Sprite;
    public PImage tower1Sprite;
    public PImage tower2Sprite;
    private PImage wizard_houseSprite;
    public PImage wormSprite;
    public PImage beetleSprite;

    // System
    public static final int FPS = 60;
    public String configPath;
    public JSONObject configJson;
    public JSONArray wavesArray;
    private String layoutPath;
<span class="fc" id="L74">    private boolean firstTimeDrawMap = true;</span>
    private int wizardXCoord;
    private int wizardYCoord;
<span class="fc" id="L77">    public enum Action {</span>
<span class="fc" id="L78">        Tower, Bomb;</span>
    }
<span class="fc" id="L80">    public int numManaPoolUses = 0;</span>
<span class="fc" id="L81">    private ArrayList&lt;int[]&gt; searchStartPoints = new ArrayList&lt;&gt;(); // int corresponding to tile number; not actual pixels</span>
<span class="fc" id="L82">    public ArrayList&lt;float[]&gt; spawnPoints = new ArrayList&lt;&gt;(); // actual position in terms of pixels ; takes topbar into account</span>
<span class="fc" id="L83">    public HashMap&lt;Integer, ArrayList&lt;int[]&gt;&gt; allPathsPoints = new HashMap&lt;&gt;();</span>
<span class="fc" id="L84">    public boolean justCalledExtraDraw = false;</span>
<span class="fc" id="L85">    private List&lt;List&lt;Integer&gt;&gt; paths = new ArrayList&lt;List&lt;Integer&gt;&gt;();</span>
    private char[][] map;
    private int[][] maze; // values will be changed by searchPath()
    private int[][] mazeReference; // keep as reference

    // GAME VARIABLES
    public float mana;
    public int manaCap;
    public static float MANA_POOL_INIT_COST;
    public static float BOMB_COST;
    public float TOWER_COST;
<span class="fc" id="L96">    public float TOWER_UPGRADE_COST = 20;</span>
    public float BOMB_RADIUS;
    private float BOMB_DAMAGE;
    private float MANA_POOL_COST_INCREASE_PER_USE;
    private float INIT_MANA_GAINED_PER_SECOND;
    private float INIT_MANA_GAINED_PER_FRAME;
    private float MANA_POOL_MANA_GAINED_MULTIPLIER;
    private float MANA_POOL_MANA_CAP_MULTIPLIER;
<span class="fc" id="L104">    public float manaGainedOnKillMultiplier = 1;</span>
<span class="fc" id="L105">    private float manaTrickleMultiplier = 1;</span>
<span class="fc" id="L106">    public Action selectedAction = null;</span>
<span class="fc" id="L107">    public boolean rangeUpgradeSelected = false;</span>
<span class="fc" id="L108">    public boolean speedUpgradeSelected = false;</span>
<span class="fc" id="L109">    public boolean damageUpgradeSelected = false;</span>
<span class="fc" id="L110">    public boolean paused = false;</span>
<span class="fc" id="L111">    public boolean fastForward = false;</span>
<span class="fc" id="L112">    public boolean gameOver = false;</span>
<span class="fc" id="L113">    public boolean won = false;</span>

    // Class instances
    public ButtonController buttonController;
    public WaveController waveController;
    public MonsterController monsterController;
    public BombController bombController;
    public TowerController towerController;
    public UIManager uiManager;

    /**
     * Determines if path exists, returns true or false. Stores coordinates along shortest path in an ArrayList
     *
     * @param maze 2D array representing the map
     * @param x The x-coordinate of starting position
     * @param y The y-coordinate of starting position
     * @param path ArrayList to which coordinates along shortest path will be stored
     * @return true if path exists from given point (x, y) to the target; false otherwise
     */
    public boolean searchPath(int[][] maze, int x, int y, List&lt;Integer&gt; path) {
        // 9 represents wizard house
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (maze[y][x] == 9) {</span>
<span class="fc" id="L135">            path.add(x);</span>
<span class="fc" id="L136">            path.add(y);</span>
<span class="fc" id="L137">            return true;</span>
        }

        // 0 represents path
<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (maze[y][x] == 0) {</span>
            // change to 2 to mean that this tile has been traversed
<span class="fc" id="L143">            maze[y][x] = 2;</span>
            
<span class="fc" id="L145">            int dx = -1;</span>
<span class="fc" id="L146">            int dy = 0;</span>
            try {
<span class="fc bfc" id="L148" title="All 2 branches covered.">                if (searchPath(maze, x + dx, y + dy, path)) {</span>
<span class="fc" id="L149">                    path.add(x);</span>
<span class="fc" id="L150">                    path.add(y);</span>
<span class="fc" id="L151">                    return true;</span>
                }
<span class="fc" id="L153">            } catch (Exception e) {</span>
                // can safely ignore exceptions here.
<span class="fc" id="L155">            }</span>
            
<span class="fc" id="L157">            dx = 1;</span>
<span class="fc" id="L158">            dy = 0;</span>
            try {
<span class="fc bfc" id="L160" title="All 2 branches covered.">                if (searchPath(maze, x + dx, y + dy, path)) {</span>
<span class="fc" id="L161">                    path.add(x);</span>
<span class="fc" id="L162">                    path.add(y);</span>
<span class="fc" id="L163">                    return true;</span>
                }
<span class="nc" id="L165">            } catch (Exception e) {</span>
                // can safely ignore exceptions here.
<span class="fc" id="L167">            }</span>

<span class="fc" id="L169">            dx = 0;</span>
<span class="fc" id="L170">            dy = -1;</span>
            try {
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">                if (searchPath(maze, x + dx, y + dy, path)) {</span>
<span class="nc" id="L173">                    path.add(x);</span>
<span class="nc" id="L174">                    path.add(y);</span>
<span class="nc" id="L175">                    return true;</span>
                }
<span class="fc" id="L177">            } catch (Exception e) {</span>
                // can safely ignore exceptions here.
<span class="fc" id="L179">            }</span>

<span class="fc" id="L181">            dx = 0;</span>
<span class="fc" id="L182">            dy = 1;</span>
            try {
<span class="fc bfc" id="L184" title="All 2 branches covered.">                if (searchPath(maze, x + dx, y + dy, path)) {</span>
<span class="fc" id="L185">                    path.add(x);</span>
<span class="fc" id="L186">                    path.add(y);</span>
<span class="fc" id="L187">                    return true;</span>
                }
<span class="nc" id="L189">            } catch (Exception e) {</span>
                // can safely ignore exceptions here.
<span class="fc" id="L191">            }</span>
        }
        // return false if no valid path from given point to wizard house
<span class="fc" id="L194">        return false;</span>
    }

    /**
     * Constructor
     */
<span class="fc" id="L200">    public App() {</span>
<span class="fc" id="L201">        this.configPath = &quot;config.json&quot;; // set path to config.json file</span>
<span class="fc" id="L202">    }</span>

    /**
     * Initialise the setting of the window size.
     */
	@Override // means that this method is intended to override a method with the same signature from the superclass or interface.
    public void settings() {
        // set window size.
<span class="fc" id="L210">        size(WIDTH, HEIGHT);</span>
<span class="fc" id="L211">    }</span>

    /**
     * Checks if the given coordinates form a corner in path.
     *
     * @param prevCoord The coordinates of the previous point.
     * @param coord The coordinates of the current point.
     * @param nextCoord The coordinates of the next point.
     * @return true if the three points form a corner, false otherwise.
     */
    public boolean isCorner(int[] prevCoord, int[] coord, int[] nextCoord) {
        // values
<span class="fc" id="L223">        int px = prevCoord[0];</span>
<span class="fc" id="L224">        int py = prevCoord[1];</span>
<span class="fc" id="L225">        int x = coord[0];</span>
<span class="fc" id="L226">        int y = coord[1];</span>
<span class="fc" id="L227">        int nx = nextCoord[0];</span>
<span class="fc" id="L228">        int ny = nextCoord[1];</span>

        // logic to determine if is not corner
<span class="fc bfc" id="L231" title="All 8 branches covered.">        if ((px == x &amp;&amp; x == nx) || (py == y &amp;&amp; y == ny)) {</span>
<span class="fc" id="L232">            return false;</span>
        }
<span class="fc" id="L234">        return true;</span>
    }

    /**
     * Handles drawing of map
     */
    private void drawMap() {

        // initialise
<span class="fc" id="L243">        map = new char[BOARD_WIDTH][BOARD_WIDTH];</span>

        try {
<span class="fc" id="L246">            Scanner scan = new Scanner(new File(layoutPath));</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">            for (int i = 0; i &lt; BOARD_WIDTH; i++) {</span>
<span class="fc" id="L248">                String line = scan.nextLine();</span>
<span class="fc" id="L249">                map[i] = line.toCharArray();</span>
            }

<span class="fc bfc" id="L252" title="All 2 branches covered.">            for (int y = 0; y &lt; BOARD_WIDTH; y++) {</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">                for (int x = 0; x &lt; BOARD_WIDTH; x++) {</span>
<span class="fc" id="L254">                    int xCoord = x * CELLSIZE;</span>
<span class="fc" id="L255">                    int yCoord = TOPBAR + (y * CELLSIZE);</span>
                    char tile;
<span class="fc" id="L257">                    PImage graphic = grassSprite;</span>
                    try {
<span class="fc" id="L259">                        tile = map[y][x];</span>
<span class="nc" id="L260">                    } catch (ArrayIndexOutOfBoundsException e) {</span>
<span class="nc" id="L261">                        tile = ' ';</span>
<span class="fc" id="L262">                    }</span>

<span class="fc bfc" id="L264" title="All 2 branches covered.">                    if (firstTimeDrawMap) {</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">                        if (tile == 'X') {</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">                            if (x == 0) {</span>
<span class="fc" id="L267">                                this.searchStartPoints.add(new int[]{x, y});</span>
<span class="fc" id="L268">                                this.spawnPoints.add(new float[]{(float) (xCoord - CELLSIZE), (float) yCoord});</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">                            } else if (y == 0) {</span>
<span class="fc" id="L270">                                this.searchStartPoints.add(new int[]{x, y});</span>
<span class="fc" id="L271">                                this.spawnPoints.add(new float[]{(float) xCoord, (float) (yCoord - CELLSIZE)});</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">                            } else if (x == (BOARD_WIDTH - 1)) {</span>
<span class="nc" id="L273">                                this.searchStartPoints.add(new int[]{x, y});</span>
<span class="nc" id="L274">                                this.spawnPoints.add(new float[]{(float) (xCoord + CELLSIZE), (float) yCoord});</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                            } else if (y == (BOARD_WIDTH - 1)) {</span>
<span class="nc" id="L276">                                this.searchStartPoints.add(new int[]{x, y});</span>
<span class="nc" id="L277">                                this.spawnPoints.add(new float[]{(float) xCoord, (float) (yCoord + CELLSIZE)});</span>
                            }
                        }
                    } 
                    
<span class="fc bfc" id="L282" title="All 2 branches covered.">                    if (tile == ' ') {</span>
<span class="fc" id="L283">                        graphic = grassSprite;</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">                    } else if (tile == 'S') {</span>
<span class="fc" id="L285">                        graphic = shrubSprite;</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">                    } else if (tile == 'W') {</span>
<span class="fc" id="L287">                        wizardXCoord = xCoord + WIZARD_X_OFFSET;</span>
<span class="fc" id="L288">                        wizardYCoord = yCoord + WIZARD_Y_OFFSET;</span>
<span class="fc" id="L289">                        graphic = grassSprite;</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">                    } else if (tile == 'X') {</span>
<span class="fc" id="L291">                        char tileLeft = 'X';</span>
<span class="fc" id="L292">                        char tileRight = 'X';</span>
<span class="fc" id="L293">                        char tileAbove = 'X';</span>
<span class="fc" id="L294">                        char tileBelow = 'X';</span>
                        try {
<span class="fc" id="L296">                            tileLeft = map[y][x-1];</span>
<span class="fc" id="L297">                        } catch (ArrayIndexOutOfBoundsException e) {</span>
<span class="fc" id="L298">                        }</span>

                        try {
<span class="fc" id="L301">                            tileRight = map[y][x+1];</span>
<span class="nc" id="L302">                        } catch (ArrayIndexOutOfBoundsException e) {</span>
<span class="fc" id="L303">                        }</span>

                        try {
<span class="fc" id="L306">                            tileAbove = map[y-1][x];</span>
<span class="fc" id="L307">                        } catch (ArrayIndexOutOfBoundsException e) {</span>
<span class="fc" id="L308">                        }</span>

                        try {
<span class="fc" id="L311">                            tileBelow = map[y+1][x];</span>
<span class="nc" id="L312">                        } catch (ArrayIndexOutOfBoundsException e) {</span>
<span class="fc" id="L313">                        }</span>
                        
<span class="fc bfc" id="L315" title="All 4 branches covered.">                        if (tileLeft == 'X' || tileRight == 'X') {</span>
<span class="fc" id="L316">                            graphic = this.path0_1Sprite;</span>
                        }
<span class="fc bfc" id="L318" title="All 4 branches covered.">                        if (tileAbove == 'X' || tileBelow == 'X') {</span>
<span class="fc" id="L319">                            graphic = this.path0_2Sprite;</span>
                        }
<span class="fc bfc" id="L321" title="All 8 branches covered.">                        if (tileAbove == 'X' &amp;&amp; tileBelow == 'X' &amp;&amp; tileLeft == 'X' &amp;&amp; tileRight == 'X') {</span>
<span class="fc" id="L322">                            graphic = this.path3Sprite;</span>
<span class="pc bpc" id="L323" title="1 of 8 branches missed.">                        } else if (tileAbove != 'X' &amp;&amp; tileBelow == 'X' &amp;&amp; tileLeft == 'X' &amp;&amp; tileRight == 'X') {</span>
<span class="nc" id="L324">                            graphic = this.path2_1Sprite;</span>
<span class="pc bpc" id="L325" title="1 of 8 branches missed.">                        } else if (tileAbove == 'X' &amp;&amp; tileBelow == 'X' &amp;&amp; tileLeft == 'X' &amp;&amp; tileRight != 'X') {</span>
<span class="fc" id="L326">                            graphic = this.path2_2Sprite;</span>
<span class="fc bfc" id="L327" title="All 8 branches covered.">                        } else if (tileAbove == 'X' &amp;&amp; tileBelow != 'X' &amp;&amp; tileLeft == 'X' &amp;&amp; tileRight == 'X') {</span>
<span class="fc" id="L328">                            graphic = this.path2_3Sprite;</span>
<span class="pc bpc" id="L329" title="2 of 8 branches missed.">                        } else if (tileAbove == 'X' &amp;&amp; tileBelow == 'X' &amp;&amp; tileLeft != 'X' &amp;&amp; tileRight == 'X') {</span>
<span class="nc" id="L330">                            graphic = this.path2_4Sprite;</span>
<span class="pc bpc" id="L331" title="1 of 8 branches missed.">                        } else if (tileAbove != 'X' &amp;&amp; tileBelow == 'X' &amp;&amp; tileLeft == 'X' &amp;&amp; tileRight != 'X') {</span>
<span class="fc" id="L332">                            graphic = this.path1_1Sprite;</span>
<span class="pc bpc" id="L333" title="1 of 8 branches missed.">                        } else if (tileAbove == 'X' &amp;&amp; tileBelow != 'X' &amp;&amp; tileLeft == 'X' &amp;&amp; tileRight != 'X') {</span>
<span class="fc" id="L334">                            graphic = this.path1_2Sprite;</span>
<span class="pc bpc" id="L335" title="2 of 8 branches missed.">                        } else if (tileAbove == 'X' &amp;&amp; tileBelow != 'X' &amp;&amp; tileLeft != 'X' &amp;&amp; tileRight == 'X') {</span>
<span class="nc" id="L336">                            graphic = this.path1_3Sprite;</span>
<span class="pc bpc" id="L337" title="1 of 8 branches missed.">                        } else if (tileAbove != 'X' &amp;&amp; tileBelow == 'X' &amp;&amp; tileLeft != 'X' &amp;&amp; tileRight == 'X') {</span>
<span class="fc" id="L338">                            graphic = this.path1_4Sprite;</span>
                        } 
                    }
<span class="fc bfc" id="L341" title="All 2 branches covered.">                    if (!firstTimeDrawMap) {</span>
<span class="fc" id="L342">                        this.image(graphic, xCoord, yCoord);</span>
                    }
                }
            }
<span class="fc bfc" id="L346" title="All 2 branches covered.">            if (!firstTimeDrawMap) {</span>
<span class="fc" id="L347">                this.image(wizard_houseSprite, wizardXCoord, wizardYCoord);</span>
            }
<span class="nc" id="L349">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L350">            e.printStackTrace();</span>
<span class="fc" id="L351">        }</span>

<span class="fc bfc" id="L353" title="All 2 branches covered.">        if (firstTimeDrawMap) {</span>
<span class="fc" id="L354">            mazeReference = new int[BOARD_WIDTH][BOARD_WIDTH];</span>
<span class="fc" id="L355">            maze = new int[BOARD_WIDTH][BOARD_WIDTH];</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">            for (int j=0; j&lt;BOARD_WIDTH;j++) {</span>
<span class="fc bfc" id="L357" title="All 2 branches covered.">                for (int i=0; i&lt;BOARD_WIDTH; i++) {</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">                    if (map[j][i] == 'W') {</span>
<span class="fc" id="L359">                        mazeReference[j][i] = 9;</span>
<span class="fc" id="L360">                        maze[j][i] = 9;</span>

<span class="fc bfc" id="L362" title="All 2 branches covered.">                    } else if (map[j][i] == 'X') {</span>
<span class="fc" id="L363">                        mazeReference[j][i] = 0;</span>
<span class="fc" id="L364">                        maze[j][i] = 0;</span>

                    } else {
<span class="fc" id="L367">                        mazeReference[j][i] = 1;</span>
<span class="fc" id="L368">                        maze[j][i] = 1;</span>

                    }
                    
                }

            }
            
<span class="fc bfc" id="L376" title="All 2 branches covered.">            for (int pointIndex = 0; pointIndex &lt; searchStartPoints.size(); pointIndex++) {</span>

<span class="fc" id="L378">                int[] searchStartPoint = searchStartPoints.get(pointIndex);</span>
<span class="fc" id="L379">                int startX = searchStartPoint[0];</span>
<span class="fc" id="L380">                int startY = searchStartPoint[1];</span>
                
<span class="fc" id="L382">                paths.add(new ArrayList&lt;Integer&gt;());</span>
<span class="fc" id="L383">                searchPath(maze, startX, startY, paths.get(pointIndex));</span>

                // Revert maze to original by overwriting its elements with those from mazeReference
<span class="fc bfc" id="L386" title="All 2 branches covered.">                for (int j=0;j&lt;BOARD_WIDTH;j++) {</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">                    for (int i=0;i&lt;BOARD_WIDTH;i++) {</span>
<span class="fc" id="L388">                        int n = mazeReference[j][i];</span>
<span class="fc" id="L389">                        maze[j][i] = n;</span>
                    }
                }
            }

<span class="fc bfc" id="L394" title="All 2 branches covered.">            for (int pathIndex = 0; pathIndex &lt; paths.size(); pathIndex++) {</span>
<span class="fc" id="L395">                List&lt;Integer&gt; path = paths.get(pathIndex);</span>

<span class="fc" id="L397">                int[][] pathPoints = new int[(int) path.size()/2][2];</span>
<span class="fc" id="L398">                int index = 0;</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">                for (int i = path.size() - 1; i &gt;= 1; i -= 2) {</span>
<span class="fc" id="L400">                    pathPoints[index][1] = path.get(i) * CELLSIZE + TOPBAR;</span>
<span class="fc" id="L401">                    pathPoints[index][0] = path.get(i-1) * CELLSIZE;</span>
<span class="fc" id="L402">                    index += 1;</span>
                }

<span class="fc" id="L405">                ArrayList&lt;int[]&gt; simplifiedPath = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L406" title="All 2 branches covered.">                for (int i = 0; i &lt; pathPoints.length; i++) {</span>
<span class="fc" id="L407">                    int[] coord = pathPoints[i];</span>

<span class="fc bfc" id="L409" title="All 4 branches covered.">                    if (i == 0 || (i == pathPoints.length-1)) {</span>
<span class="fc" id="L410">                        simplifiedPath.add(coord);</span>
<span class="fc" id="L411">                        continue;</span>
                    }
                    
<span class="fc bfc" id="L414" title="All 2 branches covered.">                    if (isCorner(pathPoints[i-1], coord, pathPoints[i+1])) {</span>
<span class="fc" id="L415">                        simplifiedPath.add(coord);</span>
                    }
                }

                // add simplifiedPath (ie corners only) to allPathsPoints
<span class="fc" id="L420">                allPathsPoints.put(pathIndex, simplifiedPath);</span>
            }

<span class="fc" id="L423">            firstTimeDrawMap = false;</span>
        }
        
<span class="fc" id="L426">    }</span>

    /**
     * Load all resources such as images. Initialise the elements such as the player, enemies and map elements. Also create necessary instances of classes.
     */
	@Override
    public void setup() {
<span class="fc" id="L433">        frameRate(FPS);</span>

        // Set window title
<span class="fc" id="L436">        this.surface.setTitle(&quot;Wizard Tower Defense&quot;);</span>

        // get info from JSON file
<span class="fc" id="L439">        configJson = loadJSONObject(this.configPath);</span>
<span class="fc" id="L440">        this.layoutPath = configJson.getString(&quot;layout&quot;);</span>
<span class="fc" id="L441">        this.mana = configJson.getInt(&quot;initial_mana&quot;);</span>
<span class="fc" id="L442">        this.manaCap = configJson.getInt(&quot;initial_mana_cap&quot;);</span>
<span class="fc" id="L443">        MANA_POOL_INIT_COST = configJson.getFloat(&quot;mana_pool_spell_initial_cost&quot;);</span>
<span class="fc" id="L444">        TOWER_COST = configJson.getFloat(&quot;tower_cost&quot;);</span>
<span class="fc" id="L445">        BOMB_COST = configJson.getFloat(&quot;bomb_cost&quot;);</span>
<span class="fc" id="L446">        BOMB_RADIUS = configJson.getFloat(&quot;bomb_damage_radius&quot;);</span>
<span class="fc" id="L447">        BOMB_DAMAGE = configJson.getFloat(&quot;bomb_damage&quot;);</span>
<span class="fc" id="L448">        this.MANA_POOL_COST_INCREASE_PER_USE = configJson.getFloat(&quot;mana_pool_spell_cost_increase_per_use&quot;);</span>
<span class="fc" id="L449">        this.INIT_MANA_GAINED_PER_SECOND = configJson.getFloat(&quot;initial_mana_gained_per_second&quot;);</span>
<span class="fc" id="L450">        this.INIT_MANA_GAINED_PER_FRAME = INIT_MANA_GAINED_PER_SECOND / FPS;</span>
<span class="fc" id="L451">        this.MANA_POOL_MANA_GAINED_MULTIPLIER = configJson.getFloat(&quot;mana_pool_spell_mana_gained_multiplier&quot;);</span>
<span class="fc" id="L452">        this.MANA_POOL_MANA_CAP_MULTIPLIER = configJson.getFloat(&quot;mana_pool_spell_cap_multiplier&quot;);</span>
        
<span class="fc" id="L454">        wavesArray = configJson.getJSONArray(&quot;waves&quot;);</span>

        // Load images during setup
<span class="fc" id="L457">        this.grassSprite = this.loadImage(&quot;src/main/resources/WizardTD/grass.png&quot;);</span>
<span class="fc" id="L458">        this.path0_1Sprite = this.loadImage(&quot;src/main/resources/WizardTD/path0.png&quot;);</span>
<span class="fc" id="L459">        this.path0_2Sprite = this.rotateImageByDegrees(this.path0_1Sprite, 90);</span>
<span class="fc" id="L460">        this.path1_1Sprite = this.loadImage(&quot;src/main/resources/WizardTD/path1.png&quot;);</span>
<span class="fc" id="L461">        this.path1_2Sprite = this.rotateImageByDegrees(this.path1_1Sprite, 90);</span>
<span class="fc" id="L462">        this.path1_3Sprite = this.rotateImageByDegrees(this.path1_1Sprite, 180);</span>
<span class="fc" id="L463">        this.path1_4Sprite = this.rotateImageByDegrees(this.path1_1Sprite, 270);</span>
<span class="fc" id="L464">        this.path2_1Sprite = this.loadImage(&quot;src/main/resources/WizardTD/path2.png&quot;);</span>
<span class="fc" id="L465">        this.path2_2Sprite = this.rotateImageByDegrees(this.path2_1Sprite, 90);</span>
<span class="fc" id="L466">        this.path2_3Sprite = this.rotateImageByDegrees(this.path2_1Sprite, 180);</span>
<span class="fc" id="L467">        this.path2_4Sprite = this.rotateImageByDegrees(this.path2_1Sprite, 270);</span>
<span class="fc" id="L468">        this.path3Sprite = this.loadImage(&quot;src/main/resources/WizardTD/path3.png&quot;);</span>
<span class="fc" id="L469">        this.shrubSprite = this.loadImage(&quot;src/main/resources/WizardTD/shrub.png&quot;);</span>
<span class="fc" id="L470">        this.wizard_houseSprite = this.loadImage(&quot;src/main/resources/WizardTD/wizard_house.png&quot;);</span>
<span class="fc" id="L471">        this.tower0Sprite = this.loadImage(&quot;src/main/resources/WizardTD/tower0.png&quot;);</span>
<span class="fc" id="L472">        this.tower1Sprite = this.loadImage(&quot;src/main/resources/WizardTD/tower1.png&quot;);</span>
<span class="fc" id="L473">        this.tower2Sprite = this.loadImage(&quot;src/main/resources/WizardTD/tower2.png&quot;);</span>
<span class="fc" id="L474">        this.gremlinSprite = this.loadImage(&quot;src/main/resources/WizardTD/gremlin.png&quot;);</span>
<span class="fc" id="L475">        this.wormSprite = this.loadImage(&quot;src/main/resources/WizardTD/worm.png&quot;);</span>
<span class="fc" id="L476">        this.beetleSprite = this.loadImage(&quot;src/main/resources/WizardTD/beetle.png&quot;);</span>
<span class="fc" id="L477">        this.bombSprite = this.loadImage(&quot;src/main/resources/WizardTD/bomb.png&quot;);</span>

<span class="fc bfc" id="L479" title="All 2 branches covered.">        for (int i = 1; i &lt;= NUMBER_OF_GREMLIN_DEATH_FRAMES; i++) {</span>
<span class="fc" id="L480">            this.gremlinDeathSprites.add(this.loadImage(&quot;src/main/resources/WizardTD/gremlin&quot; + Integer.toString(i) + &quot;.png&quot;));</span>
        }

        // create instance of ButtonController
<span class="fc" id="L484">        buttonController = new ButtonController(this);</span>
        
<span class="fc" id="L486">        float buttonX = CELLSIZE * BOARD_WIDTH + BUTTON_LEFT_MARGIN;</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">        for (int i = 0; i &lt; ButtonController.ButtonAction.values().length; i++) {</span>
<span class="fc" id="L488">            buttonController.addButton(buttonX, (TOPBAR + (i+1)*BUTTON_TOP_MARGIN + i*Button.HEIGHT), ButtonController.ButtonAction.values()[i], ButtonController.BUTTON_LABELS[i], ButtonController.BUTTON_DESCS[i]);</span>
        }

        // call drawMap function which displays tiles etc.
<span class="fc" id="L492">        this.drawMap();</span>

        // create required instances of controller classes
<span class="fc" id="L495">        waveController = new WaveController(this);</span>
<span class="fc" id="L496">        monsterController = new MonsterController(this);</span>
<span class="fc" id="L497">        bombController = new BombController();</span>
<span class="fc" id="L498">        towerController = new TowerController(this);</span>
<span class="fc" id="L499">        uiManager = new UIManager(this);</span>
<span class="fc" id="L500">    }</span>

    /**
     * Retrieves the current cost to buy mana pool spell.
     *
     * @return The current mana pool cost, represented as a floating-point value.
     */
    public float getManaPoolCost() {
<span class="nc" id="L508">        return (MANA_POOL_INIT_COST + (numManaPoolUses * MANA_POOL_COST_INCREASE_PER_USE));</span>
    }

    /**
     * Called when mana pool spell is bought; handles required actions.
     */
    private void manaPoolAction() {
<span class="nc" id="L515">        float cost = getManaPoolCost();</span>

<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (this.mana &gt;= cost) {</span>
<span class="nc" id="L518">            this.mana -= cost;</span>

            // increment numManaPoolUses
<span class="nc" id="L521">            numManaPoolUses++;</span>

            // update max mana limit
<span class="nc" id="L524">            this.manaCap = Math.round(this.manaCap * MANA_POOL_MANA_CAP_MULTIPLIER);</span>

            // update mana gained multiplier
<span class="nc" id="L527">            this.manaGainedOnKillMultiplier = this.manaTrickleMultiplier = 1 + ((float) (MANA_POOL_MANA_GAINED_MULTIPLIER - 1) * numManaPoolUses);</span>
        }
<span class="nc" id="L529">    }</span>

    /**
     * Called when bomb button or key is pressed; handles required actions.
     */
    public void toggleBomb() {

        // un-select other options
<span class="fc" id="L537">        rangeUpgradeSelected = false;</span>
<span class="fc" id="L538">        speedUpgradeSelected = false;</span>
<span class="fc" id="L539">        damageUpgradeSelected = false;</span>

        // toggle
<span class="fc bfc" id="L542" title="All 2 branches covered.">        if (selectedAction == Action.Bomb) {</span>
<span class="fc" id="L543">            selectedAction = null;</span>
        } else {
<span class="fc" id="L545">            selectedAction = Action.Bomb;</span>
        }
<span class="fc" id="L547">    }</span>

    /**
     * Called when upgrade range button or key is pressed; handles required actions.
     */
    private void toggleRange() {
<span class="nc bnc" id="L553" title="All 2 branches missed.">        if (selectedAction == Action.Bomb) {</span>
<span class="nc" id="L554">                selectedAction = null;</span>
        }
<span class="nc bnc" id="L556" title="All 2 branches missed.">        rangeUpgradeSelected = !rangeUpgradeSelected;</span>
<span class="nc" id="L557">    }</span>

    /**
     * Called when upgrade speed button or key is pressed; handles required actions.
     */
    void toggleSpeed() {
<span class="nc bnc" id="L563" title="All 2 branches missed.">        if (selectedAction == Action.Bomb) {</span>
<span class="nc" id="L564">                selectedAction = null;</span>
        }
<span class="nc bnc" id="L566" title="All 2 branches missed.">        speedUpgradeSelected = !speedUpgradeSelected;</span>
<span class="nc" id="L567">    }</span>

    /**
     * Called when upgrade damage button or key is pressed; handles required actions.
     */
    void toggleDamage() {
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (selectedAction == Action.Bomb) {</span>
<span class="nc" id="L574">                selectedAction = null;</span>
        }
<span class="nc bnc" id="L576" title="All 2 branches missed.">        damageUpgradeSelected = !damageUpgradeSelected;</span>
<span class="nc" id="L577">    }</span>

    /**
     * Called when build tower button or key is pressed; handles required actions.
     */
    void toggleTower() {
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (selectedAction == Action.Tower) {</span>
<span class="nc" id="L584">            selectedAction = null;</span>
        } else {
<span class="nc" id="L586">            selectedAction = Action.Tower;</span>
        }
<span class="nc" id="L588">    }</span>

    /**
     * Receive key pressed signal from the keyboard.
     */
	@Override
    public void keyPressed(){
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if (gameOver) {</span>
<span class="nc bnc" id="L596" title="All 4 branches missed.">            if ((key == 'r') || (key == 'R')) {</span>
                
<span class="nc bnc" id="L598" title="All 2 branches missed.">                if (!won) {</span>
                    //restart by resetting all values, objects, etc.
<span class="nc" id="L600">                    this.numManaPoolUses = 0;</span>
<span class="nc" id="L601">                    this.mana = configJson.getInt(&quot;initial_mana&quot;);</span>
<span class="nc" id="L602">                    this.manaCap = configJson.getInt(&quot;initial_mana_cap&quot;);</span>

<span class="nc" id="L604">                    manaGainedOnKillMultiplier = 1;</span>
<span class="nc" id="L605">                    manaTrickleMultiplier = 1;</span>
<span class="nc" id="L606">                    selectedAction = null;</span>
<span class="nc" id="L607">                    rangeUpgradeSelected = false;</span>
<span class="nc" id="L608">                    speedUpgradeSelected = false;</span>
<span class="nc" id="L609">                    damageUpgradeSelected = false;</span>
<span class="nc" id="L610">                    paused = false;</span>
<span class="nc" id="L611">                    fastForward = false;</span>
<span class="nc" id="L612">                    gameOver = false;</span>
<span class="nc" id="L613">                    won = false;</span>

                    // make fresh instances
<span class="nc" id="L616">                    monsterController = new MonsterController(this);</span>
<span class="nc" id="L617">                    towerController = new TowerController(this);</span>
<span class="nc" id="L618">                    waveController = new WaveController(this);</span>
                }
                
            }
        } else {
<span class="nc bnc" id="L623" title="All 4 branches missed.">            if ((key == 'p') || (key == 'P')) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                paused = !paused;</span>
<span class="nc bnc" id="L625" title="All 4 branches missed.">            } else if ((key == 'f') || (key == 'F')) {</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                fastForward = !fastForward;</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">            } else if (key == '1') {</span>
<span class="nc" id="L628">                toggleRange();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">            } else if (key == '2') {</span>
<span class="nc" id="L630">                toggleSpeed();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            } else if (key == '3') {</span>
<span class="nc" id="L632">                toggleDamage();</span>
<span class="nc bnc" id="L633" title="All 4 branches missed.">            } else if ((key == 'm') || (key == 'M')) {</span>
<span class="nc" id="L634">                manaPoolAction();</span>
<span class="nc bnc" id="L635" title="All 4 branches missed.">            } else if ((key == 'b') || (key == 'B')) {</span>
<span class="nc" id="L636">                toggleBomb();</span>
<span class="nc bnc" id="L637" title="All 4 branches missed.">            } else if ((key == 't') || (key == 'T')) {</span>
<span class="nc" id="L638">                toggleTower();</span>
            }
        }

        
<span class="nc" id="L643">    }</span>

    /**
     * Checks if a tower exists at the specified coordinates (x, y).
     *
     * @param x The X-coordinate of the specified location.
     * @param y The Y-coordinate of the specified location.
     * @return An integer representing the existence of a tower:
     *         - number corresponding to index of the tower instance in the List towerController.towers, if it exists
     *         - -1 if no tower exists at the given coordinates.
     */
    public int towerExists(float x, float y) {
<span class="fc bfc" id="L655" title="All 2 branches covered.">        for (int i = 0; i &lt; this.towerController.towers.size(); i++) {</span>
<span class="fc" id="L656">            Tower t = this.towerController.towers.get(i);</span>
<span class="pc bpc" id="L657" title="1 of 4 branches missed.">            if ((t.x == x) &amp;&amp; (t.y == y)) {</span>
<span class="fc" id="L658">                return i; // tower exists; return its index</span>
            }
        }
<span class="fc" id="L661">        return -1;  // tower does not exist; return -1 to indicate this</span>
    }

    /**
     * Converts a given mouse X and Y position to grid coordinates corresponding to tile indexes.
     *
     * @param mouseXPos The X position of the mouse cursor as a float.
     * @param mouseYPos The Y position of the mouse cursor as a float.
     * @return 
     *         - An integer array containing the grid coordinates (i.e. tile indexes) [gridX, gridY].
     *         - null if mouse is not inside the map
     */
    private int[] getGridCoords(float mouseXPos, float mouseYPos) {
<span class="fc" id="L674">        int mapX = (int) Math.round(mouseXPos);</span>
<span class="fc" id="L675">        int mapY = (int) Math.round(mouseYPos - TOPBAR);</span>
<span class="fc" id="L676">        int gridX = Math.round((mapX - (mapX % CELLSIZE)) / CELLSIZE);</span>
<span class="fc" id="L677">        int gridY = Math.round((mapY - (mapY % CELLSIZE)) / CELLSIZE);</span>

<span class="pc bpc" id="L679" title="3 of 8 branches missed.">        if ((gridX &gt;= 0) &amp;&amp; (gridX &lt; BOARD_WIDTH) &amp;&amp; (gridY &gt;= 0) &amp;&amp; (gridY &lt; BOARD_WIDTH)) {</span>
<span class="fc" id="L680">            return new int[]{gridX, gridY}; </span>
        }

<span class="fc" id="L683">        return null;</span>
    }

    /**
     * Calculates the distance between two points (x1, y1) and (x2, y2).
     *
     * @param x1 The X-coordinate of the first point.
     * @param y1 The Y-coordinate of the first point.
     * @param x2 The X-coordinate of the second point.
     * @param y2 The Y-coordinate of the second point.
     * @return The distance between the two points as a double.
     */
    public double distance(float x1, float y1, float x2, float y2) {
<span class="fc" id="L696">        return Math.sqrt(Math.pow((x2 - x1), 2) + Math.pow((y2 - y1), 2));</span>
    }

    /**
     * Calculates cost required to build a tower, given the initial upgrades selected.
     *
     * @return Total cost as a float.
     */
    public float getBuildTowerCost() { // get cost given upgrades selected; EVEN IF CANNOT AFFORD ALL (returns theoretical total cost)
<span class="fc" id="L705">        float upgradesCost = 0;</span>
<span class="fc bfc" id="L706" title="All 2 branches covered.">        if (rangeUpgradeSelected) {</span>
<span class="fc" id="L707">            upgradesCost += TOWER_UPGRADE_COST;</span>
        }
<span class="fc bfc" id="L709" title="All 2 branches covered.">        if (speedUpgradeSelected) {</span>
<span class="fc" id="L710">            upgradesCost += TOWER_UPGRADE_COST;</span>
        }
<span class="fc bfc" id="L712" title="All 2 branches covered.">        if (damageUpgradeSelected) {</span>
<span class="fc" id="L713">            upgradesCost += TOWER_UPGRADE_COST;</span>
        }

<span class="fc" id="L716">        return (TOWER_COST + upgradesCost);</span>
    }

    /**
     * Invoked when a mouse button is pressed
     *
     * @param mouseEvent The MouseEvent object containing information about the event.
     */
    @Override
    public void mousePressed(MouseEvent mouseEvent) {
<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (mouseButton == LEFT) {</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">            if (selectedAction == Action.Bomb) {</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">                if (mana &gt;= BOMB_COST) {</span>
<span class="nc bnc" id="L729" title="All 8 branches missed.">                    if ((mouseX &gt;= 0) &amp;&amp; (mouseX &lt;= CELLSIZE*BOARD_WIDTH) &amp;&amp; (mouseY &gt;= TOPBAR) &amp;&amp; (mouseY &lt;= (CELLSIZE*BOARD_WIDTH + TOPBAR))) {</span>
<span class="nc" id="L730">                        selectedAction = null;</span>

                        // deploy bomb
<span class="nc" id="L733">                        mana -= BOMB_COST;</span>
<span class="nc" id="L734">                        bombController.addBomb(new Bomb(mouseX, mouseY, BOMB_RADIUS, BOMB_DAMAGE, this));</span>
<span class="nc" id="L735">                        return;</span>
                    }
                }
            }

<span class="nc bnc" id="L740" title="All 2 branches missed.">            for (Button button : buttonController.buttons) {</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">                if (button.hovered) {</span>
<span class="nc bnc" id="L742" title="All 9 branches missed.">                    switch (button.action) {</span>
                        case FastForward:
<span class="nc bnc" id="L744" title="All 2 branches missed.">                            fastForward = !fastForward;</span>
<span class="nc" id="L745">                            break;</span>
                        case Pause:
<span class="nc bnc" id="L747" title="All 2 branches missed.">                            paused = !paused;</span>
<span class="nc" id="L748">                            break;</span>
                        case Tower:
<span class="nc" id="L750">                            toggleTower();</span>
<span class="nc" id="L751">                            break;</span>
                        case Range:
<span class="nc" id="L753">                            toggleRange();</span>
<span class="nc" id="L754">                            break;</span>
                        case Speed:
<span class="nc" id="L756">                            toggleSpeed();</span>
<span class="nc" id="L757">                            break;</span>
                        case Damage:
<span class="nc" id="L759">                            toggleDamage();</span>
<span class="nc" id="L760">                            break;</span>
                        case ManaPool:
<span class="nc" id="L762">                            manaPoolAction();</span>
<span class="nc" id="L763">                            break;</span>
                        case Bomb:
<span class="nc" id="L765">                            toggleBomb();</span>
                            break;
                    }

<span class="nc" id="L769">                    return;</span>
                }
<span class="nc" id="L771">            }</span>

<span class="nc bnc" id="L773" title="All 2 branches missed.">            if (selectedAction == Action.Tower) {</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">                if (mana &gt;= TOWER_COST) {</span>
<span class="nc bnc" id="L775" title="All 8 branches missed.">                    if (rangeUpgradeSelected &amp;&amp; speedUpgradeSelected &amp;&amp; damageUpgradeSelected &amp;&amp; mana &lt; (TOWER_COST + 3*TOWER_UPGRADE_COST)) {</span>
<span class="nc" id="L776">                        damageUpgradeSelected = false;</span>
                    }
<span class="nc bnc" id="L778" title="All 6 branches missed.">                    if (rangeUpgradeSelected &amp;&amp; speedUpgradeSelected &amp;&amp; mana &lt; (TOWER_COST + 2*TOWER_UPGRADE_COST)) {</span>
<span class="nc" id="L779">                        speedUpgradeSelected = false;</span>
                    }
<span class="nc bnc" id="L781" title="All 6 branches missed.">                    if (rangeUpgradeSelected &amp;&amp; damageUpgradeSelected &amp;&amp; mana &lt; (TOWER_COST + 2*TOWER_UPGRADE_COST)) {</span>
<span class="nc" id="L782">                        damageUpgradeSelected = false;</span>
                    }
<span class="nc bnc" id="L784" title="All 6 branches missed.">                    if (speedUpgradeSelected &amp;&amp; damageUpgradeSelected &amp;&amp; mana &lt; (TOWER_COST + 2*TOWER_UPGRADE_COST)) {</span>
<span class="nc" id="L785">                        damageUpgradeSelected = false;</span>
                    }
<span class="nc bnc" id="L787" title="All 4 branches missed.">                    if (rangeUpgradeSelected &amp;&amp; (mana &lt; (TOWER_COST + TOWER_UPGRADE_COST))) {</span>
<span class="nc" id="L788">                        rangeUpgradeSelected = false;</span>

                    }
<span class="nc bnc" id="L791" title="All 4 branches missed.">                    if (speedUpgradeSelected &amp;&amp; (mana &lt; (TOWER_COST + TOWER_UPGRADE_COST))) {</span>
<span class="nc" id="L792">                        speedUpgradeSelected = false;</span>
                    }
<span class="nc bnc" id="L794" title="All 4 branches missed.">                    if (damageUpgradeSelected &amp;&amp; (mana &lt; (TOWER_COST + TOWER_UPGRADE_COST))) {</span>
<span class="nc" id="L795">                        damageUpgradeSelected = false;</span>
                    }

<span class="nc" id="L798">                    float upgradesCost = 0;</span>
<span class="nc" id="L799">                    int initRangeLevel = 0;</span>
<span class="nc" id="L800">                    int initSpeedLevel = 0;</span>
<span class="nc" id="L801">                    int initDamageLevel = 0;</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">                    if (rangeUpgradeSelected) {</span>
<span class="nc" id="L803">                        upgradesCost += TOWER_UPGRADE_COST;</span>
<span class="nc" id="L804">                        initRangeLevel = 1;</span>
                    }
<span class="nc bnc" id="L806" title="All 2 branches missed.">                    if (speedUpgradeSelected) {</span>
<span class="nc" id="L807">                        upgradesCost += TOWER_UPGRADE_COST;</span>
<span class="nc" id="L808">                        initSpeedLevel = 1;</span>
                    }
<span class="nc bnc" id="L810" title="All 2 branches missed.">                    if (damageUpgradeSelected) {</span>
<span class="nc" id="L811">                        upgradesCost += TOWER_UPGRADE_COST;</span>
<span class="nc" id="L812">                        initDamageLevel = 1;</span>
                    }

<span class="nc" id="L815">                    float totalCost = TOWER_COST + upgradesCost;</span>

<span class="nc" id="L817">                    int[] gridCoords = getGridCoords(mouseX, mouseY);</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">                    if (gridCoords != null) {</span>
<span class="nc" id="L819">                        int gridX = gridCoords[0];</span>
<span class="nc" id="L820">                        int gridY = gridCoords[1];</span>
                        
                            try {
<span class="nc" id="L823">                                char tile = map[gridY][gridX];</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                                if (tile == ' ') {</span>
<span class="nc" id="L825">                                    float placeX = gridX * CELLSIZE;</span>
<span class="nc" id="L826">                                    float placeY = (gridY * CELLSIZE) + TOPBAR;</span>

<span class="nc bnc" id="L828" title="All 2 branches missed.">                                    if (towerExists(placeX, placeY) == -1) { // if no tower exists at that location</span>
                                        // buy tower
<span class="nc" id="L830">                                        mana -= totalCost;</span>
<span class="nc" id="L831">                                        towerController.addTower(new Tower(placeX, placeY, initRangeLevel, initSpeedLevel,initDamageLevel, this));</span>
                                        
<span class="nc" id="L833">                                        selectedAction = null;</span>
<span class="nc" id="L834">                                        rangeUpgradeSelected = false;</span>
<span class="nc" id="L835">                                        speedUpgradeSelected = false;</span>
<span class="nc" id="L836">                                        damageUpgradeSelected = false;</span>

<span class="nc" id="L838">                                        return;</span>
                                    }
                                }
<span class="nc" id="L841">                            } catch (Exception e) {</span>
                                // can safely ignore exception, because exception means selected spot is outside map, so no tower will be built.
<span class="nc" id="L843">                            }</span>
                    }

<span class="nc" id="L846">                }</span>
            } else { // not selected Build Tower
                // if any upgrade selected:
<span class="nc bnc" id="L849" title="All 6 branches missed.">                if (rangeUpgradeSelected || speedUpgradeSelected || damageUpgradeSelected) {</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">                    if (towerController.currentHoverTowerIndex != -1) { // if a tower is being hovered over (hover index of -1 means no tower being hovered)</span>
<span class="nc" id="L851">                        Tower towerToUpgrade = towerController.towers.get(towerController.currentHoverTowerIndex);</span>
<span class="nc" id="L852">                        float rangeCost = TOWER_UPGRADE_COST + 10*towerToUpgrade.rangeLevel;</span>
<span class="nc" id="L853">                        float speedCost = TOWER_UPGRADE_COST + 10*towerToUpgrade.speedLevel;</span>
<span class="nc" id="L854">                        float damageCost = TOWER_UPGRADE_COST + 10*towerToUpgrade.damageLevel;</span>

                        // buy upgrades if can afford, in the order specified.
<span class="nc bnc" id="L857" title="All 4 branches missed.">                        if (rangeUpgradeSelected &amp;&amp; mana &gt;= rangeCost) {</span>
<span class="nc" id="L858">                            mana -= rangeCost;</span>
<span class="nc" id="L859">                            towerToUpgrade.rangeLevel++;</span>
                        }
<span class="nc bnc" id="L861" title="All 4 branches missed.">                        if (speedUpgradeSelected &amp;&amp; mana &gt;= speedCost) {</span>
<span class="nc" id="L862">                            mana -= speedCost;</span>
<span class="nc" id="L863">                            towerToUpgrade.speedLevel++;</span>
                        }
<span class="nc bnc" id="L865" title="All 4 branches missed.">                        if (damageUpgradeSelected &amp;&amp; mana &gt;= damageCost) {</span>
<span class="nc" id="L866">                            mana -= damageCost;</span>
<span class="nc" id="L867">                            towerToUpgrade.damageLevel++;</span>
                        }

<span class="nc" id="L870">                        towerToUpgrade.updateStats();</span>

<span class="nc" id="L872">                        rangeUpgradeSelected = false;</span>
<span class="nc" id="L873">                        speedUpgradeSelected = false;</span>
<span class="nc" id="L874">                        damageUpgradeSelected = false;</span>

<span class="nc" id="L876">                        return;</span>
                    }
                }
            }
        }
<span class="nc" id="L881">    }</span>

    /**
     * If mouse is hovering over a tower, set towerController.currentHoverTowerIndex to the index of the tower currently hovering over
     */
    public void setHoverTowerIndex() {
<span class="fc" id="L887">        float x = mouseX;</span>
<span class="fc" id="L888">        float y = mouseY;</span>

<span class="fc" id="L890">        int[] gridCoords = getGridCoords(x, y);</span>
<span class="fc bfc" id="L891" title="All 2 branches covered.">        if (gridCoords != null) { // if mouse is on the map i.e. not outside map</span>
<span class="fc" id="L892">            float pixelX = gridCoords[0] * CELLSIZE;</span>
<span class="fc" id="L893">            float pixelY = gridCoords[1] * CELLSIZE + TOPBAR;</span>

<span class="fc" id="L895">            int towerIndex = towerExists(pixelX, pixelY);</span>

<span class="fc" id="L897">            this.towerController.currentHoverTowerIndex = towerIndex; // works because if not hovering over tower, towerIndex == currentHoverTowerIndex == -1</span>
        }
<span class="fc" id="L899">    }</span>

    /**
     * Draw all elements in the game by current frame.
     */
	@Override
    public void draw() { // main loop here. if fps is 60, then draw() runs 60 times per sec

<span class="pc bpc" id="L907" title="1 of 2 branches missed.">        if (gameOver) {</span>
<span class="nc" id="L908">            this.textSize(40);</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">            if (won) {</span>
<span class="nc" id="L910">                this.fill(255,0,200);</span>
<span class="nc" id="L911">                this.text(&quot;YOU WIN&quot;,260,200);</span>
            } else {
<span class="nc" id="L913">                this.fill(0,255,0);</span>
<span class="nc" id="L914">                this.text(&quot;YOU LOST&quot;,250,200);</span>
<span class="nc" id="L915">                this.textSize(20);</span>
<span class="nc" id="L916">                this.text(&quot;Press 'r' to restart&quot;,260,235);</span>
            }

<span class="nc" id="L919">            monsterController.tick();</span>
<span class="nc" id="L920">            monsterController.draw();</span>
        } else {
<span class="fc" id="L922">            setHoverTowerIndex();</span>
        
<span class="pc bpc" id="L924" title="1 of 2 branches missed.">            if (paused) {</span>
<span class="nc" id="L925">                this.drawMap();</span>
<span class="nc" id="L926">                monsterController.draw();</span>
<span class="nc" id="L927">                towerController.draw();</span>
<span class="nc" id="L928">                uiManager.drawUI();</span>
            } else {
<span class="fc" id="L930">                waveController.tick();</span>

<span class="fc" id="L932">                this.mana += INIT_MANA_GAINED_PER_FRAME * manaTrickleMultiplier;</span>
                
<span class="fc" id="L934">                this.drawMap();</span>
                
                // call tick and draw to update and display
<span class="fc" id="L937">                monsterController.tick();</span>
<span class="fc" id="L938">                monsterController.draw();</span>

                // call tick and draw to update and display
<span class="fc" id="L941">                towerController.tick();</span>
<span class="fc" id="L942">                towerController.draw();</span>

<span class="pc bpc" id="L944" title="1 of 2 branches missed.">                if (this.mana &gt; this.manaCap) {</span>
<span class="nc" id="L945">                    this.mana = this.manaCap;</span>
                }

                // draw the User Interface
<span class="nc" id="L949">                uiManager.drawUI();</span>
            }
<span class="nc bnc" id="L951" title="All 2 branches missed.">            if (fastForward) {</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">                if (justCalledExtraDraw) { // this check using justCalledExtraDraw prevents infinite recursion.</span>
<span class="nc" id="L953">                    justCalledExtraDraw = false;</span>
                } else {
<span class="nc" id="L955">                    justCalledExtraDraw = true;</span>
                    // call draw() again if fast-forwarding.
<span class="nc" id="L957">                    this.draw();</span>
                }
            }
        }
<span class="nc" id="L961">    }</span>

    /**
     * Increases mana by an amount equal to the raw mana gained from a kill, multiplied by the value manaGainedOnKillMultiplier
     *
     * @param rawMana The raw mana gained from the kill as a float.
     */
    public void gainManaForKill(float rawMana) {
<span class="fc" id="L969">        this.mana += rawMana * manaGainedOnKillMultiplier;</span>
<span class="fc" id="L970">    }</span>

    /**
     * Decreases mana by a specified amount and checks for game over conditions.
     *
     * @param manaDecrease The amount of mana to decrease as a float.
     */
    public void loseMana(float manaDecrease) {
<span class="fc" id="L978">        this.mana -= manaDecrease;</span>

<span class="fc bfc" id="L980" title="All 2 branches covered.">        if (this.mana &lt; 0) {</span>
<span class="fc" id="L981">            this.mana = 0;</span>
<span class="fc" id="L982">            gameOver = true;</span>
        }
<span class="fc" id="L984">    }</span>

    /**
     * The main entry point for the WizardTD application.
     *
     * @param args An array of command-line arguments (not used in this program).
     */
    public static void main(String[] args) {
<span class="fc" id="L992">        PApplet.main(&quot;WizardTD.App&quot;);</span>
<span class="fc" id="L993">    }</span>

    /**
     * Rotates a given PImage clockwise by the specified angle in degrees. Source: https://stackoverflow.com/questions/37758061/rotate-a-buffered-image-in-java
     * @param pimg The image to be rotated
     * @param angle between 0 and 360 degrees (Clockwise rotation)
     * @return the new rotated image
     */
    public PImage rotateImageByDegrees(PImage pimg, double angle) {
<span class="fc" id="L1002">        BufferedImage img = (BufferedImage) pimg.getNative();</span>
<span class="fc" id="L1003">        double rads = Math.toRadians(angle);</span>
<span class="fc" id="L1004">        double sin = Math.abs(Math.sin(rads)), cos = Math.abs(Math.cos(rads));</span>
<span class="fc" id="L1005">        int w = img.getWidth();</span>
<span class="fc" id="L1006">        int h = img.getHeight();</span>
<span class="fc" id="L1007">        int newWidth = (int) Math.floor(w * cos + h * sin);</span>
<span class="fc" id="L1008">        int newHeight = (int) Math.floor(h * cos + w * sin);</span>

<span class="fc" id="L1010">        PImage result = this.createImage(newWidth, newHeight, ARGB);</span>
<span class="fc" id="L1011">        BufferedImage rotated = (BufferedImage) result.getNative();</span>
<span class="fc" id="L1012">        Graphics2D g2d = rotated.createGraphics();</span>
<span class="fc" id="L1013">        AffineTransform at = new AffineTransform();</span>
<span class="fc" id="L1014">        at.translate((newWidth - w) / 2, (newHeight - h) / 2);</span>

<span class="fc" id="L1016">        int x = w / 2;</span>
<span class="fc" id="L1017">        int y = h / 2;</span>

<span class="fc" id="L1019">        at.rotate(rads, x, y);</span>
<span class="fc" id="L1020">        g2d.setTransform(at);</span>
<span class="fc" id="L1021">        g2d.drawImage(img, 0, 0, null);</span>
<span class="fc" id="L1022">        g2d.dispose();</span>

<span class="fc bfc" id="L1024" title="All 2 branches covered.">        for (int i = 0; i &lt; newWidth; i++) {</span>
<span class="fc bfc" id="L1025" title="All 2 branches covered.">            for (int j = 0; j &lt; newHeight; j++) {</span>
<span class="fc" id="L1026">                result.set(i, j, rotated.getRGB(i, j));</span>
            }
        }

<span class="fc" id="L1030">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>